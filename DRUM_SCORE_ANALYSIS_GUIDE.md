# 드럼 악보 분석 시스템 사용 가이드

## 개요

연속된 음원에서 드럼 사운드를 감지하고 악보처럼 시간대별로 표시하는 AI 기반 분석 시스템입니다.

## 주요 특징

### 1. 정밀 분석
- 0.5초 윈도우, 0.05초 간격으로 세밀하게 분석
- 모든 감지된 드럼 사운드를 빠짐없이 기록
- 중복 제거 알고리즘으로 정확한 결과 제공

### 2. 악보 스타일 출력
- 시간축 기반 타임라인 표시
- 0.1초 단위 상세 타임라인
- 클래스별 통계 및 분포

### 3. 시각화
- 악보 스타일 타임라인 차트
- 클래스별 분포 그래프
- 시간대별 밀도 분석

## 사용 방법

### 기본 사용법

```python
from models.drum_score_analyzer import DrumScoreAnalyzer

# 1. 분석기 초기화
analyzer = DrumScoreAnalyzer("models/final_crnn_drum_model.h5")

# 2. 음원 분석
results, duration = analyzer.analyze_continuous_audio("your_audio.wav")

# 3. 결과 출력
analyzer.print_score_timeline(results, duration)
analyzer.print_detailed_results(results)

# 4. 시각화
analyzer.create_score_visualization(results, duration, "your_audio.wav", 
                                   save_path="output/result.png")

# 5. 결과 파일 저장
analyzer.export_results(results, duration, "output/result.txt")
```

### 테스트 실행

```bash
python scripts/test_score_analysis.py
```

## 출력 형식

### 1. 콘솔 출력

```
================================================================================
드럼 악보 분석 결과
================================================================================

[분석 통계]
총 음원 길이: 2.00초
감지된 드럼 사운드: 3개

[클래스별 분포]
  CC (크래시심벌): 1개
  LT (로우톰): 1개
  MT (미드톰): 1개

[타임라인 - 악보 형식]
--------------------------------------------------------------------------------
시간(초)   | 드럼 종류            | 신뢰도    
--------------------------------------------------------------------------------
  0.00     | CC (크래시심벌)      | 91.5%     
  0.16     | MT (미드톰)          | 100.0%    
  0.42     | LT (로우톰)          | 100.0%    

[상세 타임라인 - 0.1초 단위]
--------------------------------------------------------------------------------
 0.00s | CC
 0.10s | MT
 0.20s | MT
 0.30s |
 0.40s | LT
 0.50s | LT
...
```

### 2. 텍스트 파일 출력

- 분석 통계
- 클래스별 분포
- 타임라인 (시간, 드럼 종류, 신뢰도)
- 상세 분석 결과

### 3. 시각화 출력

- **타임라인 차트**: 드럼 종류별 y축, 시간별 x축
- **클래스별 분포**: 각 드럼 종류의 개수
- **시간대별 밀도**: 0.5초 단위로 드럼 사운드 밀도

## 파라미터 설정

```python
analyzer.window_size = 0.5              # 윈도우 크기 (초)
analyzer.hop_size = 0.05                # 이동 간격 (초)
analyzer.confidence_threshold = 0.5     # 신뢰도 임계값
```

### 권장 설정값

| 목적 | window_size | hop_size | confidence_threshold |
|------|-------------|----------|---------------------|
| 매우 정밀 분석 | 0.5초 | 0.05초 | 0.5 |
| 일반 분석 | 1.0초 | 0.1초 | 0.6 |
| 빠른 분석 | 2.0초 | 0.2초 | 0.7 |

## 드럼 클래스

| 약어 | 영문명 | 한국어명 |
|------|--------|----------|
| BD | bass_drum | 베이스드럼 |
| CC | crash_cymbal | 크래시심벌 |
| HT | high_tom | 하이톰 |
| HH | hihat_closed | 클로즈드하이햇 |
| OH | hihat_open | 오픈하이햇 |
| LT | low_tom | 로우톰 |
| MT | mid_tom | 미드톰 |
| RC | ride_cymbal | 라이드심벌 |
| SD | snare_drum | 스네어드럼 |

## 분석 알고리즘

### 1. 슬라이딩 윈도우 분석
```
음원 → 0.5초 윈도우로 분할 → 0.05초씩 이동 → 각 윈도우 분류
```

### 2. 후처리
```
모든 결과 수집 → 시간순 정렬 → 중복 제거 → 최종 결과
```

### 3. 중복 제거 로직
- 0.2초 이내에 같은 클래스가 여러 번 감지되면
- 가장 높은 신뢰도를 가진 결과만 선택

## 출력 파일

분석 완료 후 `output/` 폴더에 다음 파일들이 생성됩니다:

- `drum_score_analysis.png`: 시각화 결과
- `drum_score_analysis_results.txt`: 상세 분석 결과

## 문제 해결

### 1. 드럼 사운드가 너무 많이 감지됨
```python
analyzer.confidence_threshold = 0.7  # 임계값 높이기
analyzer.hop_size = 0.1              # 이동 간격 늘리기
```

### 2. 드럼 사운드를 놓침
```python
analyzer.confidence_threshold = 0.4  # 임계값 낮추기
analyzer.hop_size = 0.025            # 이동 간격 줄이기
```

### 3. 분석 속도가 느림
```python
analyzer.window_size = 1.0   # 윈도우 크기 늘리기
analyzer.hop_size = 0.2      # 이동 간격 늘리기
```

## 활용 예시

### 1. 드럼 커버 연습
- 원곡의 드럼 패턴 분석
- 각 박자에 어떤 드럼이 사용되었는지 확인

### 2. 음악 제작
- 기존 곡의 드럼 패턴 참고
- 비트 분석 및 템포 확인

### 3. 음악 교육
- 드럼 악보 자동 생성
- 학생들에게 드럼 패턴 설명

## 기술 사양

- **딥러닝 모델**: CRNN (Convolutional Recurrent Neural Network)
- **입력**: WAV, MP3 등 오디오 파일
- **샘플레이트**: 22050Hz로 자동 변환
- **특징 추출**: 멜 스펙트로그램 (128 mel bins)
- **정확도**: 약 99% (9가지 드럼 클래스)

## 버전 정보

- **v1.0**: 초기 버전 - 기본 분석 기능
- **v2.0**: 악보 스타일 출력 추가
- **v2.1**: 중복 제거 알고리즘 개선
- **v2.2**: 상세 타임라인 추가 (0.1초 단위)


